# 本地知识库功能设计文档

> 类似 NotebookLM 的本地知识库系统，支持批量导入 Markdown 文件，自动生成总结文档和 PPT 大纲。

---

## 1. 功能概述

本知识库系统提供以下核心功能：

- **知识库管理**：创建、删除、列出知识库
- **文档导入**：批量导入 Markdown 文件，自动解析和分块
- **内容处理**：智能文本分块、标题结构提取、元数据管理
- **AI 生成**（待实现）：自动总结、PPT 大纲生成

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 (Vue 3 + Pinia)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ KnowledgeBase   │  │ knowledgeBase   │  │ types/      │ │
│  │ Manager.vue     │  │ Store.ts        │  │ knowledge   │ │
│  │ (UI 组件)       │  │ (状态管理)       │  │ Base.ts     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└───────────────────────────┬─────────────────────────────────┘
                            │ Tauri Commands
┌───────────────────────────▼─────────────────────────────────┐
│                    后端 (Rust + Tauri)                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ commands.rs     │  │ knowledge_base  │  │ knowledge   │ │
│  │ (Tauri 命令)    │  │ _service.rs     │  │ _base.rs    │ │
│  │                 │  │ (业务逻辑)       │  │ (数据模型)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└───────────────────────────┬─────────────────────────────────┘
                            │ JSON 存储
┌───────────────────────────▼─────────────────────────────────┐
│                      本地文件系统                            │
│          ~/Library/Application Support/bun-codeview/        │
│                   knowledge_bases/kb_data.json              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 数据模型

### 3.1 知识库 (KnowledgeBase)
```typescript
interface KnowledgeBase {
  id: string;           // UUID
  name: string;         // 知识库名称
  description?: string; // 描述
  createdAt: string;    // 创建时间
  updatedAt: string;    // 更新时间
  documentCount: number; // 文档数量
}
```

### 3.2 文档 (Document)
```typescript
interface Document {
  id: string;           // UUID
  kbId: string;         // 所属知识库 ID
  path: string;         // 文件路径
  title: string;        // 文档标题
  content: string;      // 原始内容
  chunks: Chunk[];      // 分块
  metadata: DocumentMetadata;
  createdAt: string;
}
```

### 3.3 文本块 (Chunk)
```typescript
interface Chunk {
  id: string;
  content: string;      // 块内容
  startLine: number;    // 起始行
  endLine: number;      // 结束行
  headings: string[];   // 所属标题层级
}
```

---

## 4. API 接口

### 4.1 Tauri 命令

| 命令                    | 参数               | 返回值          | 说明           |
| ----------------------- | ------------------ | --------------- | -------------- |
| `create_knowledge_base` | name, description? | KnowledgeBase   | 创建知识库     |
| `list_knowledge_bases`  | -                  | KnowledgeBase[] | 列出所有知识库 |
| `get_knowledge_base`    | id                 | KnowledgeBase?  | 获取知识库详情 |
| `delete_knowledge_base` | id                 | void            | 删除知识库     |
| `import_documents`      | kbId, paths[]      | Document[]      | 批量导入文档   |
| `get_documents`         | kbId               | Document[]      | 获取知识库文档 |
| `delete_document`       | docId              | void            | 删除文档       |

---

## 5. 核心算法

### 5.1 Markdown 解析

解析流程：
1. 读取文件内容
2. 逐行扫描识别标题（`#` 开头）
3. 提取标题层级和文本
4. 构建文档大纲结构

### 5.2 智能分块

分块策略：
- **语义边界**：以标题为主要分割点
- **大小限制**：每块控制在 2000 字符以内
- **上下文保留**：记录块所属的标题层级

```rust
// 分块逻辑示例
if chunk_content.len() > 2000 || line.starts_with("---") {
    // 保存当前块，开始新块
}
```

---

## 6. 文件结构

```
src-tauri/src/
├── models/
│   ├── mod.rs
│   └── knowledge_base.rs     # 数据模型
├── services/
│   ├── mod.rs
│   └── knowledge_base_service.rs  # 业务逻辑
└── commands.rs               # Tauri 命令（含知识库命令）

src/
├── types/
│   └── knowledgeBase.ts      # TypeScript 类型
├── store/
│   └── knowledgeBase.ts      # Pinia Store
└── components/
    └── kb/
        └── KnowledgeBaseManager.vue  # 管理组件
```

---

## 7. 待实现功能

### 7.1 AI 总结生成
- 集成 OpenAI/本地 LLM API
- Prompt 模板管理
- 流式输出支持

### 7.2 PPT 大纲生成
- 结构化输出格式
- 自动章节划分
- Mermaid 图表集成

### 7.3 扩展功能
- PDF/TXT 文档支持
- 全文搜索
- 向量嵌入（用于语义搜索）

---

## 8. 使用指南

1. **创建知识库**：点击侧边栏 "+" 按钮
2. **导入文档**：选择知识库后，点击"导入文档"
3. **管理文档**：预览、删除已导入的文档
4. **生成内容**：（待实现）选择生成类型，执行 AI 生成

---

*文档版本: v1.0*  
*更新日期: 2026-01-19*
