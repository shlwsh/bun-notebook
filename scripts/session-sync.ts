#!/usr/bin/env bun
import { spawnSync } from "bun";
import { writeFileSync, existsSync, mkdirSync } from "fs";
import { join } from "path";

async function runGit(args: string[]) {
    const proc = spawnSync(["git", ...args]);
    if (proc.exitCode !== 0) {
        throw new Error(`Git command failed: git ${args.join(" ")}\n${proc.stderr.toString()}`);
    }
    return proc.stdout.toString().trim();
}

async function main() {
    const summary = process.argv[2];
    const details = process.argv[3] || summary;

    if (!summary) {
        console.error("âŒ é”™è¯¯: è¯·æä¾›ä¼šè¯å°ç»“ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚");
        process.exit(1);
    }

    const sessionsDir = join(process.cwd(), "sessions");
    if (!existsSync(sessionsDir)) {
        mkdirSync(sessionsDir, { recursive: true });
    }

    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `session_${timestamp}.md`;
    const filePath = join(sessionsDir, filename);

    const fullContent = `# AI Session Summary - ${new Date().toLocaleString()}

## ğŸš€ ä¼šè¯å°ç»“
${summary}

## ğŸ“ è¯¦ç»†è®°å½•
${details}

---
*Generated by Bun CodeView Session Sync*
`;

    console.log(`ğŸ“„ æ­£åœ¨åˆ›å»ºä¼šè¯æ–‡ä»¶: ${filename}`);
    writeFileSync(filePath, fullContent);

    try {
        console.log("ğŸ“¦ æ‰§è¡Œ git add .");
        await runGit(["add", "."]);

        console.log(`ğŸ’¾ æ‰§è¡Œ git commit -m "Session: ${summary}"`);
        await runGit(["commit", "-m", `Session: ${summary}`]);

        console.log("â¬†ï¸ æ‰§è¡Œ git push");
        await runGit(["push"]);

        console.log("âœ… ä¼šè¯å·²åŒæ­¥å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼");
    } catch (e) {
        console.error(`âŒ åŒæ­¥å¤±è´¥: ${e.message}`);
        process.exit(1);
    }
}

main().catch(console.error);
